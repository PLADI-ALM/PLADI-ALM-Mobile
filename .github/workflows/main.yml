name: Deploy iOS and Android App to App Store and Play Store
on:
  push:
    branches:
      - beta
  pull_request:
jobs:
  beta-ios:
    name: Build and release iOS app
    runs-on: macos-latest
    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2.8.0
        with:
          flutter-version: '3.13.9'
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'
      - name: 캐시된 빌드 파일 초기화
        run: flutter clean 

      - name: 패키지 다운로드
        run: flutter pub get

      - name: Pod 초기화
        run: rm -f ios/Podfile.lock && rm -rf ios/Pods
  
      - name: Pod repository 업데이트
        run: cd ios && pod install --repo-update
  
      - name: IOS Prod 빌드
        run: flutter build ios --release --no-codesign --flavor production -t lib/main_prod.dart
  
      - name: fastlane 설치
        run: arch -arm64 brew install fastlane
  
      - name: app store 배포
        run: cd ios && fastlane beta
        env: 
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          SLACK_WEBHOOK_URL: ${{ secrets.IOS_SLACK }}
        timeout-minutes: 40
  beta-android:
    name: Build and release Android app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '12.x'
      - uses: subosito/flutter-action@v2.8.0
        with:
          flutter-version: '3.13.9'
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'
      - name: 캐시된 빌드 파일 초기화
        run: flutter clean 

      - name: 패키지 다운로드
        run: flutter pub get

      - name: Prebuild
        run: flutter build appbundle

      - name: Execute Fastlane command
        run: cd android && fastlane beta
        env: 
          SLACK_WEBHOOK_URL: ${{ secrets.IOS_SLACK }}